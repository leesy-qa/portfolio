# CDN 캐시 동작 이해 및 이슈 분석 정리

## 📌 문제 상황
- 특정 CDN 주소 (`https://cdn.topialive.co.kr/1619923800587/leveltest-v2-written-test-intro.mp4`)를 사용하는 페이지에 접속했을 때, **영상이 처음에는 로딩되지 않음**
- 새로고침 이후 정상적으로 영상 표시됨

---

## ✅ 문제를 파고들며 확인한 내용 요약

### 🔹 CDN 캐시는 어디에 생기나?
- **엣지 서버**: CloudFront와 같은 CDN 제공자의 전 세계 분산 서버에 저장됨
- **브라우저 캐시**: 사용자의 로컬 브라우저에도 별도로 저장될 수 있음

---

### 🔹 `Cache-Control: no-cache`의 의미
- 캐시를 **완전히 금지하는 게 아님**
- CDN이나 브라우저가 **파일을 저장할 수는 있지만**, 사용할 때마다 **origin 서버에 유효성 확인을 요청함**
- 결과적으로 속도는 느릴 수 있으나, 항상 최신 버전을 제공하려는 보수적이고 안전한 설정

---

### 🔹 CloudFront에서의 캐시 동작
- CloudFront는 **지역별 엣지 서버**에 따라 캐시 여부가 다름
- 예: 한국 사용자가 많이 접속하면 서울 엣지에는 캐시가 생성되지만, 미국 유저가 처음 접속하면 **origin 요청이 발생**함 (`x-cache: Miss`)
- 이후에는 해당 지역에서도 `x-cache: Hit`로 전환

---

### 🔹 x-cache 헤더
- `Hit from CloudFront`: 엣지 서버 캐시에서 응답
- `Miss from CloudFront`: origin 서버로부터 받아온 후 캐싱함
- `Expired`, `RefreshHit`, `Revalidated` 등 다양한 상태가 있을 수 있음

---

## 🔍 추정 원인: 영상이 처음에 로딩되지 않은 이유
- 해당 영상의 `Cache-Control`이 `no-cache`로 설정돼 있었기 때문에:
  - **브라우저나 CDN이 캐시된 파일을 사용하지 않고, origin에 재검증 요청을 보냄**
  - 네트워크 지연, origin 응답 대기 등의 이유로 영상 로딩이 일시적으로 실패했을 가능성
- 새로고침 후 정상 표시된 것은 재요청 결과 캐시 또는 응답이 성공했기 때문

---

## 🧠 이런 경우를 대비한 전략
- 영상이 자주 변경되는 경우: `Cache-Control: no-cache`는 합리적인 선택
- 영상이 고정 콘텐츠이고, 글로벌 사용자 대상일 경우:  
  → `Cache-Control: public, max-age=31536000`처럼 설정하여 **성능 최적화** 가능
- 다만 변경 발생 시 버저닝 필수 (`video-v2.mp4?version=20250804` 등)

---

## ✅ 결론
- 현재 설정은 **보수적이지만 안전한 설정**으로 판단됨
- 영상이 자주 바뀌는 환경이라면 유지해도 좋고,  
  글로벌 성능이나 속도가 중요할 경우 캐시 정책 재검토 필요
- 영상이 안 떴던 현상은 일시적인 캐시 미스나 재검증 지연 가능성이 높음

---

## 🔧 참고한 CDN 도구
- `curl -I <url>`: 캐시 상태 확인
- F12 → Network → Headers: 브라우저 캐시/응답 확인
- `x-cache`, `cache-control`, `age` 등의 헤더로 CDN 동작 추적
